name: ðŸ”’ Security & Dependency Management

on:
  schedule:
    - cron: '0 0 * * *'  # Daily security scan
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write
  security-events: write

jobs:
  # ðŸ” Security Audit
  security-audit:
    name: ðŸ” Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ðŸ”’ Run Pip Audit
      run: |
        pip install pip-audit
        cd backend
        pip-audit -r requirements.txt --desc || true
        
    - name: ðŸ“Š Generate Security Report
      if: github.event_name == 'schedule'
      run: |
        cd backend
        pip-audit -r requirements.txt --format json > security-audit.json || true
        
    - name: ðŸ“¤ Upload Security Report
      if: github.event_name == 'schedule'
      uses: actions/upload-artifact@v3
      with:
        name: security-audit
        path: backend/security-audit.json

  # ðŸ¤– Auto-merge Dependabot PRs
  dependabot-auto-merge:
    name: ðŸ¤– Auto-merge Dependabot
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' && github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ” Get Dependabot metadata
      id: metadata
      uses: dependabot/fetch-metadata@v2
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"
        
    - name: âœ… Auto-approve security updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'security'
      run: gh pr review --approve "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ”€ Auto-merge security updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'security'
      run: gh pr merge --auto --merge "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ðŸ›¡ï¸ SAST Scanning
  sast-scan:
    name: ðŸ›¡ï¸ SAST Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ” Run Bandit Security Scan
      run: |
        pip install bandit
        cd backend
        bandit -r app/ -f json -o bandit-report.json || true
        
    - name: ðŸ” Run Semgrep
      uses: returntocorp/semgrep-action@v1
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        
    - name: ðŸ“¤ Upload SARIF results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: semgrep.sarif

  # ðŸ“‹ Vulnerability Summary
  vulnerability-summary:
    name: ðŸ“‹ Vulnerability Summary
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'push'
    needs: [security-audit, sast-scan]
    
    steps:
    - name: ðŸ“Š Create Issue if Critical Vulnerabilities Found
      run: |
        echo "## ðŸ”’ Security Status Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“… Date: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Scan Results:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependency audit completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… SAST scan completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check the [Dependabot alerts](https://github.com/${{ github.repository }}/security/dependabot) for details." >> $GITHUB_STEP_SUMMARY 